<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>CS ON THE GO</title>
    <%- include(getViewPath("/core/views/common/common.ejs")) %>
</head>
<body>
<%- include(getViewPath("/core/views/common/header.ejs")) %>
<div class="container mt-3">
    <h3>수강 플래너</h3>

    <div class="mt-5 course-plan-info-area">
        <div>
            <h5 class="d-inline">수강 플랜명</h5>
            <input type="text" class="input-text01" name="course-plan-name"/>
        </div>
        <input type="button" class="big-btn01" value="저장" />
    </div>

    <div class="course-search-area">
        <div>
            <h5 class="d-inline">교과목 검색</h5>
            <input type="text" class="input-text01" name="course-name" placeholder="교과목명"/>
            <input type="button" class="btn01" value="검색" onclick="getCourseDataAction()"/>
        </div>
        <input type="button" class="btn01" value="추가" />
    </div>
    <div class="course-select-area">
        <div class="data-area" id="grid01"></div>
        <div class="data-area" id="grid02"></div>
    </div>

    <div class="course-timetable-area">
        <div class="text-right">
            <input type="button" class="mt-3 btn01" value="삭제"/>
        </div>
        <table class="course-timetable table01 mt-3">
            <tr>
                <th></th>
                <th>월</th>
                <th>화</th>
                <th>수</th>
                <th>목</th>
                <th>금</th>
            </tr>
            <tr>
                <th>9</th>
                <td></td>
                <td rowspan="2" class="background-yellow">자료구조<br>최상민<br>[30-304]</td>
                <td rowspan="2" class="background-lightgreen">컴퓨터구조<br>김민기<br>[30-304]</td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>10</th>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>11</th>
                <td></td>
                <td></td>
                <td></td>
                <td rowspan="2" class="background-skyblue">Java프로그래밍<br>김지윤<br>[30-304]</td>
                <td></td>
            </tr>
            <tr>
                <th>12</th>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>13</th>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>14</th>
                <td></td>
                <td rowspan="2" class="background-lightpurple">파이썬프로그래밍<br>이수원<br>[30-304]</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>15</th>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>16</th>
                <td></td>
                <td rowspan="2" class="background-red color-white">웹프로그래밍실습<br>서현<br>[30-308]</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>17</th>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <th>18</th>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
    </div>
</div>
<%- include(getViewPath("/core/views/common/footer.ejs")) %>
<script>
    let grid1 = new ForwardGrid();
    let grid2 = new ForwardGrid();
    $(function() {
        grid1.createElement({
            element: $("#grid01")[0],
            columns: [
                {
                    "columnNm": "교과목코드",
                    "columnId": "course_id"
                },
                {
                    "columnNm": "교과목명",
                    "columnId": "course_name"
                }
            ],
            clickEvent: (event) => {
                getClassDataAction();
            }
        });

        grid2.createElement({
            element: $("#grid02")[0],
            columns: [
                {
                    "columnNm": "분반",
                    "columnId": "class_id"
                },
                {
                    "columnNm": "교수명",
                    "columnId": "professor_name"
                },
                {
                    "columnNm": "캠퍼스 구분",
                    "columnId": "campus_type"
                },
                {
                    "columnNm": "강의시간",
                    "columnId": "class_time_text"
                }
            ]
        });

        getCourseDataAction();
    });

    function getCourseDataMain(params) {
        let queryString = new URLSearchParams(params).toString();
        return fetch(`/course/get-course-data?${queryString}`).then((res) => res.json()).then(data => {
            grid1.resetData(data);
        }).catch((err) => {
            alert("강의 정보를 불러오는 중에 오류가 발생했습니다.");
            throw err;
        });
    }

    function getCourseDataAction() {
        let courseName = document.getElementsByName("course-name")[0].value;
        getCourseDataMain({course_name: courseName});
    }

    function getClassDataMain(params) {
        let queryString = new URLSearchParams(params).toString();
        return fetch(`/course/get-class-data?${queryString}`).then((res) => res.json()).then(data => {
            data.forEach((iv) => {
                iv.class_time_text = convertClassTimeListToString(iv.class_time_list);
            });
            grid2.resetData(data);

        }).catch((err) => {
            alert("분반 정보를 불러오는 중에 오류가 발생했습니다.");
            throw err;
        });
    }

    function getClassDataAction() {
        let courseId = grid1.getSelectedRowData().course_id;
        getClassDataMain({course_id: courseId});
    }

    function convertClassTimeListToString(arr) {
        const days = {};

        arr.forEach(item => {
            const day = item.slice(0, 1);

            const number = item.slice(1);

            if (days[day]) {
                days[day].push(number);
            } else {
                days[day] = [number];
            }
        });

        let result = "";

        for (const day in days) {
            if (result !== "") {
                result += "/";
            }

            result += `${day}${days[day].join(',')}`;
        }

        return result;
    }
</script>
</body>
</html>